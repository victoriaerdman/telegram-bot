import os
import logging
import tempfile
import html
from typing import Dict, List, Any
from telegram import InlineKeyboardButton, InlineKeyboardMarkup, Update
from telegram.ext import (
    Application, CommandHandler, CallbackQueryHandler,
    MessageHandler, ContextTypes, filters
)


BOT_TOKEN = os.getenv("8405025997:AAFRyBEu92LfUL2ddkvycRQmyao9eYUIYsc")
ADMINS = [1625817019]


WEBHOOK_URL = os.getenv("WEBHOOK_URL")  # например https://school-bot.onrender.com
PORT = int(os.getenv("PORT", "10000"))

logging.basicConfig(level=logging.INFO)


SCHOOL_INFO = {
    "address": "3, Крюкова канала наб., Санкт-Петербург, 190121",
    "phone": "8 (812) 714-40-25",
    "email": "school259@edu.ru",
    "director": "Астгик Телемаковна Кочарян"
}

CALL_SCHEDULE = {
    "1": "09:00 – 09:45",
    "2": "09:55 – 10:40",
    "3": "11:00 – 11:45",
    "4": "12:05 – 12:50",
    "5": "13:00 – 13:45",
    "6": "13:55 – 14:40",
    "7": "14:50 – 15:35",
    "8": "15:45 – 16:30"
}


SCHEDULE = {
     "1А": {
        "Понедельник": [
            {"урок": 1, "предмет": "Разговор о важном", "учитель": "Васкелайнен Л.И.", "кабинет": "12"},
            {"урок": 2, "предмет": "Русский язык", "учитель": "Васкелайнен Л.И.", "кабинет": "12"},
            {"урок": 3, "предмет": "Математика", "учитель": "Васкелайнен Л.И.", "кабинет": "12"},
            {"урок": 4, "предмет": "Литературное чтение", "учитель": "Васкелайнен Л.И.", "кабинет": "12"},
            {"урок": 5, "предмет": "Физ-ра", "учитель": "Рыжикова Н.С.", "кабинет": "Спортзал"}
        ],
        "Вторник": [
            {"урок": 1, "предмет": "Литературное чтение", "учитель": "Васкелайнен Л.И.", "кабинет": "12"},
            {"урок": 2, "предмет": "Математика", "учитель": "Васкелайнен Л.И.", "кабинет": "12"},
            {"урок": 3, "предмет": "Русский язык", "учитель": "Васкелайнен Л.И.", "кабинет": "12"},
            {"урок": 4, "предмет": "ИЗО", "учитель": "Васкелайнен Л.И.", "кабинет": "12"}
        ],
        "Среда": [
            {"урок": 1, "предмет": "Окружающий мир", "учитель": "Васкелайнен Л.И.", "кабинет": "12"},
            {"урок": 2, "предмет": "Литературное чтение", "учитель": "Васкелайнен Л.И.", "кабинет": "12"},
            {"урок": 3, "предмет": "Русский язык", "учитель": "Васкелайнен Л.И.", "кабинет": "12"},
            {"урок": 4, "предмет": "Математика", "учитель": "Васкелайнен Л.И.", "кабинет": "12"},
            {"урок": 5, "предмет": "Физ-ра", "учитель": "Рыжикова Н.С.", "кабинет": "Спортзал"}
        ],
        "Четверг": [
            {"урок": 1, "предмет": "Литературное чтение", "учитель": "Васкелайнен Л.И.", "кабинет": "12"},
            {"урок": 2, "предмет": "Русский язык", "учитель": "Васкелайнен Л.И.", "кабинет": "12"},
            {"урок": 3, "предмет": "Математика", "учитель": "Васкелайнен Л.И.", "кабинет": "12"},
            {"урок": 4, "предмет": "Труд", "учитель": "Васкелайнен Л.И.", "кабинет": "12"}
        ],
        "Пятница": [
            {"урок": 1, "предмет": "Окружающий мир", "учитель": "Васкелайнен Л.И.", "кабинет": "12"},
            {"урок": 2, "предмет": "Музыка", "учитель": "Пушкарева М.С.", "кабинет": "12"},
            {"урок": 3, "предмет": "Русский язык", "учитель": "Васкелайнен Л.И.", "кабинет": "12"},
            {"урок": 4, "предмет": "Физ-ра", "учитель": "Рыжикова Н.С.", "кабинет": "Спортзал"}
        ]
    },
    "2А": {
        "Понедельник": [
            {"урок": 1, "предмет": "Разговор о важном", "учитель": "Макаренкова Н.Ю.", "кабинет": "11"},
            {"урок": 2, "предмет": "Русский язык", "учитель": "Макаренкова Н.Ю.", "кабинет": "11"},
            {"урок": 3, "предмет": "Музыка", "учитель": "Пушкарева М.С.", "кабинет": "11"},
            {"урок": 4, "предмет": "Физ-ра", "учитель": "Рыжикова Н.С.", "кабинет": "Спортзал"},
            {"урок": 5, "предмет": "Математика", "учитель": "Макаренкова Н.Ю.", "кабинет": "11"}
        ],
        "Вторник": [
            {"урок": 1, "предмет": "Литературное чтение", "учитель": "Макаренкова Н.Ю.", "кабинет": "11"},
            {"урок": 2, "предмет": "Англ.яз.", "учитель": "Боровская Ю.В.", "кабинет": "11"},
            {"урок": 3, "предмет": "Русский язык", "учитель": "Макаренкова Н.Ю.", "кабинет": "11"},
            {"урок": 4, "предмет": "Математика", "учитель": "Макаренкова Н.Ю.", "кабинет": "11"},
            {"урок": 5, "предмет": "ИЗО", "учитель": "Макаренкова Н.Ю.", "кабинет": "11"}
        ],
        "Среда": [
            {"урок": 1, "предмет": "Литературное чтение", "учитель": "Макаренкова Н.Ю.", "кабинет": "11"},
            {"урок": 2, "предмет": "Математика", "учитель": "Макаренкова Н.Ю.", "кабинет": "11"},
            {"урок": 3, "предмет": "Русский язык", "учитель": "Макаренкова Н.Ю.", "кабинет": "11"},
            {"урок": 4, "предмет": "Физ-ра", "учитель": "Рыжикова Н.С.", "кабинет": "Спортзал"},
            {"урок": 5, "предмет": "Окружающий мир", "учитель": "Макаренкова Н.Ю.", "кабинет": "11"}
        ],
        "Четверг": [
            {"урок": 1, "предмет": "Литературное чтение", "учитель": "Макаренкова Н.Ю.", "кабинет": "11"},
            {"урок": 2, "предмет": "Русский язык", "учитель": "Макаренкова Н.Ю.", "кабинет": "11"},
            {"урок": 3, "предмет": "Окружающий мир", "учитель": "Макаренкова Н.Ю.", "кабинет": "11"},
            {"урок": 4, "предмет": "Англ.яз.", "учитель": "Боровская Ю.В.", "кабинет": "11"},
            {"урок": 5, "предмет": "Труд", "учитель": "Макаренкова Н.Ю.", "кабинет": "11"}
        ],
        "Пятница": [
            {"урок": 1, "предмет": "Физ-ра", "учитель": "Рыжикова Н.С.", "кабинет": "Спортзал"},
            {"урок": 2, "предмет": "Математика", "учитель": "Макаренкова Н.Ю.", "кабинет": "11"},
            {"урок": 3, "предмет": "Русский язык", "учитель": "Макаренкова Н.Ю.", "кабинет": "11"},
            {"урок": 4, "предмет": "Литературное чтение", "учитель": "Макаренкова Н.Ю.", "кабинет": "11"}
        ]
    },
    "3А": {
        "Понедельник": [
            {"урок": 1, "предмет": "Разговор о важном", "учитель": "Евстафьева С.Д.", "кабинет": "10"},
            {"урок": 2, "предмет": "Физ-ра", "учитель": "Рыжикова Н.С.", "кабинет": "Спортзал"},
            {"урок": 3, "предмет": "Математика", "учитель": "Евстафьева С.Д.", "кабинет": "10"},
            {"урок": 4, "предмет": "Русский язык", "учитель": "Евстафьева С.Д.", "кабинет": "10"},
            {"урок": 5, "предмет": "Литературное чтение", "учитель": "Евстафьева С.Д.", "кабинет": "10"}
        ],
        "Вторник": [
            {"урок": 1, "предмет": "Русский язык", "учитель": "Евстафьева С.Д.", "кабинет": "10"},
            {"урок": 2, "предмет": "Математика", "учитель": "Евстафьева С.Д.", "кабинет": "10"},
            {"урок": 3, "предмет": "Литературное чтение", "учитель": "Евстафьева С.Д.", "кабинет": "10"},
            {"урок": 4, "предмет": "ИЗО", "учитель": "Евстафьева С.Д.", "кабинет": "10"},
            {"урок": 5, "предмет": "Англ.яз.", "учитель": "Смирнова О.И.", "кабинет": "10"}
        ],
        "Среда": [
            {"урок": 1, "предмет": "Физ-ра", "учитель": "Рыжикова Н.С.", "кабинет": "Спортзал"},
            {"урок": 2, "предмет": "Литературное чтение", "учитель": "Евстафьева С.Д.", "кабинет": "10"},
            {"урок": 3, "предмет": "Математика", "учитель": "Евстафьева С.Д.", "кабинет": "10"},
            {"урок": 4, "предмет": "Русский язык", "учитель": "Евстафьева С.Д.", "кабинет": "10"},
            {"урок": 5, "предмет": "Окружающий мир", "учитель": "Евстафьева С.Д.", "кабинет": "10"}
        ],
        "Четверг": [
            {"урок": 1, "предмет": "Англ.яз.", "учитель": "Смирнова О.И.", "кабинет": "10"},
            {"урок": 2, "предмет": "Русский язык", "учитель": "Евстафьева С.Д.", "кабинет": "10"},
            {"урок": 3, "предмет": "Музыка", "учитель": "Пушкарева М.С.", "кабинет": "10"},
            {"урок": 4, "предмет": "Литературное чтение", "учитель": "Евстафьева С.Д.", "кабинет": "10"},
            {"урок": 5, "предмет": "Труд", "учитель": "Евстафьева С.Д.", "кабинет": "10"}
        ],
        "Пятница": [
            {"урок": 1, "предмет": "Окружающий мир", "учитель": "Васкелайнен Л.И.", "кабинет": "10"},
            {"урок": 2, "предмет": "Математика", "учитель": "Евстафьева С.Д.", "кабинет": "10"},
            {"урок": 3, "предмет": "Физ-ра", "учитель": "Рыжикова Н.С.", "кабинет": "Спортзал"},
            {"урок": 4, "предмет": "Русский язык", "учитель": "Евстафьева С.Д.", "кабинет": "10"}
        ]
    },
    "4А": {
        "Понедельник": [
            {"урок": 1, "предмет": "Разговор о важном", "учитель": "Погосян Л.С.", "кабинет": "9"},
            {"урок": 2, "предмет": "Математика", "учитель": "Погосян Л.С.", "кабинет": "9"},
            {"урок": 3, "предмет": "Физ-ра", "учитель": "Рыжикова Н.С.", "кабинет": "Спортзал"},
            {"урок": 4, "предмет": "Русский язык", "учитель": "Шумилова О.В.", "кабинет": "9"},
            {"урок": 5, "предмет": "Литературное чтение", "учитель": "Погосян Л.С.", "кабинет": "9"}
        ],
        "Вторник": [
            {"урок": 1, "предмет": "Литературное чтение", "учитель": "Погосян Л.С.", "кабинет": "9"},
            {"урок": 2, "предмет": "Математика", "учитель": "Погосян Л.С.", "кабинет": "9"},
            {"урок": 3, "предмет": "Русский язык", "учитель": "Шумилова О.В.", "кабинет": "9"},
            {"урок": 4, "предмет": "Окружающий мир", "учитель": "Погосян Л.С.", "кабинет": "9"},
            {"урок": 5, "предмет": "ОРКиСЭ", "учитель": "Погосян Л.С.", "кабинет": "9"}
        ],
        "Среда": [
            {"урок": 1, "предмет": "Математика", "учитель": "Погосян Л.С.", "кабинет": "9"},
            {"урок": 2, "предмет": "Англ.яз.", "учитель": "Смирнова О.И.", "кабинет": "9"},
            {"урок": 3, "предмет": "Русский язык", "учитель": "Шумилова О.В.", "кабинет": "9"},
            {"урок": 4, "предмет": "Литературное чтение", "учитель": "Погосян Л.С.", "кабинет": "9"},
            {"урок": 5, "предмет": "ИЗО", "учитель": "Погосян Л.С.", "кабинет": "9"}
        ],
        "Четверг": [
            {"урок": 1, "предмет": "Литературное чтение", "учитель": "Погосян Л.С.", "кабинет": "9"},
            {"урок": 2, "предмет": "Музыка", "учитель": "Пушкарева М.С.", "кабинет": "9"},
            {"урок": 3, "предмет": "Русский язык", "учитель": "Шумилова О.В.", "кабинет": "9"},
            {"урок": 4, "предмет": "Окружающий мир", "учитель": "Погосян Л.С.", "кабинет": "9"},
            {"урок": 5, "предмет": "Труд", "учитель": "Погосян Л.С.", "кабинет": "9"}
        ],
        "Пятница": [
            {"урок": 1, "предмет": "Англ.яз.", "учитель": "Смирнова О.И.", "кабинет": "9"},
            {"урок": 2, "предмет": "Физ-ра", "учитель": "Рыжикова Н.С.", "кабинет": "Спортзал"},
            {"урок": 3, "предмет": "Русский язык", "учитель": "Шумилова О.В.", "кабинет": "9"},
            {"урок": 4, "предмет": "Математика", "учитель": "Погосян Л.С.", "кабинет": "9"}
        ]
    },
    "5А": {
        "Понедельник": [
            {"урок": 1, "предмет": "Разговор о важном", "учитель": "Саргсян А.С.", "кабинет": "20"},
            {"урок": 2, "предмет": "Биология", "учитель": "Макин В.П.", "кабинет": "16"},
            {"урок": 3, "предмет": "Литература", "учитель": "Смирнова О.И.", "кабинет": "17"},
            {"урок": 4, "предмет": "Математика", "учитель": "Арустамян Ан.А.", "кабинет": "31"},
            {"урок": 5, "предмет": "Музыка", "учитель": "Пушкарева М.С.", "кабинет": "19"},
            {"урок": 6, "предмет": "Русский язык", "учитель": "Смирнова О.И.", "кабинет": "17"}
        ],
        "Вторник": [
            {"урок": 1, "предмет": "Физ-ра", "учитель": "Овакимян Д.О.", "кабинет": "Спортзал"},
            {"урок": 2, "предмет": "Математика", "учитель": "Арустамян Ан.А.", "кабинет": "31"},
            {"урок": 3, "предмет": "Русский язык", "учитель": "Смирнова О.И.", "кабинет": "17"},
            {"урок": 4, "предмет": "Труд", "учитель": "Пучков И.В.", "кабинет": "30"},
            {"урок": 5, "предмет": "Англ.яз.", "учитель": "Боровская Ю.В.", "кабинет": "27"},
            {"урок": 6, "предмет": "История", "учитель": "Бердникова С.С.", "кабинет": "18"}
        ],
        "Среда": [
            {"урок": 1, "предмет": "Русский язык", "учитель": "Смирнова О.И.", "кабинет": "17"},
            {"урок": 2, "предмет": "Информатика", "учитель": "Пучков И.В.", "кабинет": "30"},
            {"урок": 3, "предмет": "Англ.яз.", "учитель": "Боровская Ю.В.", "кабинет": "27"},
            {"урок": 4, "предмет": "Литература", "учитель": "Смирнова О.И.", "кабинет": "17"},
            {"урок": 5, "предмет": "Математика", "учитель": "Арустамян Ан.А.", "кабинет": "31"},
            {"урок": 6, "предмет": "История", "учитель": "Бердникова С.С.", "кабинет": "18"}
        ],
        "Четверг": [
            {"урок": 1, "предмет": "Физ-ра", "учитель": "Овакимян Д.О.", "кабинет": "Спортзал"},
            {"урок": 2, "предмет": "Русский язык", "учитель": "Смирнова О.И.", "кабинет": "17"},
            {"урок": 3, "предмет": "Математика", "учитель": "Арустамян Ан.А.", "кабинет": "31"},
            {"урок": 4, "предмет": "Литература", "учитель": "Смирнова О.И.", "кабинет": "17"},
            {"урок": 5, "предмет": "ИЗО", "учитель": "Пушкарева М.С.", "кабинет": "19"},
            {"урок": 6, "предмет": "ОБЖ", "учитель": "Попова Т.С.", "кабинет": "28"}
        ],
        "Пятница": [
            {"урок": 1, "предмет": "Труд", "учитель": "Пучков И.В.", "кабинет": "30"},
            {"урок": 2, "предмет": "География", "учитель": "Попова Т.С.", "кабинет": "28"},
            {"урок": 3, "предмет": "Русский язык", "учитель": "Смирнова О.И.", "кабинет": "17"},
            {"урок": 4, "предмет": "История", "учитель": "Бердникова С.С.", "кабинет": "18"},
            {"урок": 5, "предмет": "Математика", "учитель": "Арустамян Ан.А.", "кабинет": "31"},
            {"урок": 6, "предмет": "Англ.яз.", "учитель": "Боровская Ю.В.", "кабинет": "27"}
        ]
    },
    "6А": {
        "Понедельник": [
            {"урок": 1, "предмет": "Разговор о важном", "учитель": "Бердникова С.С.", "кабинет": "18"},
            {"урок": 2, "предмет": "Математика", "учитель": "Арустамян Ас.А.", "кабинет": "26"},
            {"урок": 3, "предмет": "Русский язык", "учитель": "Автоделян Н.Г.", "кабинет": "29"},
            {"урок": 4, "предмет": "Русский язык", "учитель": "Автоделян Н.Г.", "кабинет": "29"},
            {"урок": 5, "предмет": "Труд", "учитель": "Пучков И.В.", "кабинет": "30"},
            {"урок": 6, "предмет": "Физ-ра", "учитель": "Рыжикова Н.С.", "кабинет": "Спортзал"}
        ],
        "Вторник": [
            {"урок": 1, "предмет": "География", "учитель": "Попова Т.С.", "кабинет": "28"},
            {"урок": 2, "предмет": "История", "учитель": "Бердникова С.С.", "кабинет": "18"},
            {"урок": 3, "предмет": "Труд", "учитель": "Пучков И.В.", "кабинет": "30"},
            {"урок": 4, "предмет": "Англ.яз.", "учитель": "Боровская Ю.В./Смирнова О.И.", "кабинет": "27/17"},
            {"урок": 5, "предмет": "Математика", "учитель": "Арустамян Ас.А.", "кабинет": "26"},
            {"урок": 6, "предмет": "Литература", "учитель": "Автоделян Н.Г.", "кабинет": "29"},
            {"урок": 7, "предмет": "Литература", "учитель": "Автоделян Н.Г.", "кабинет": "29"}
        ],
        "Среда": [
            {"урок": 1, "предмет": "Математика", "учитель": "Арустамян Ас.А.", "кабинет": "26"},
            {"урок": 2, "предмет": "Русский язык", "учитель": "Автоделян Н.Г.", "кабинет": "29"},
            {"урок": 3, "предмет": "Русский язык", "учитель": "Автоделян Н.Г.", "кабинет": "29"},
            {"урок": 4, "предмет": "Биология", "учитель": "Макин В.П.", "кабинет": "20"},
            {"урок": 5, "предмет": "История", "учитель": "Бердникова С.С.", "кабинет": "18"},
            {"урок": 6, "предмет": "Физ-ра", "учитель": "Рыжикова Н.С.", "кабинет": "Спортзал"}
        ],
        "Четверг": [
            {"урок": 1, "предмет": "Математика", "учитель": "Арустамян Ас.А.", "кабинет": "26"},
            {"урок": 2, "предмет": "Англ.яз./Информатика", "учитель": "Боровская Ю.В./Пучков И.В.", "кабинет": "27/30"},
            {"урок": 3, "предмет": "Информатика/Англ.яз.", "учитель": "Пучков И.В./Смирнова О.И.", "кабинет": "30/17"},
            {"урок": 4, "предмет": "Музыка", "учитель": "Пушкарева М.С.", "кабинет": "19"},
            {"урок": 5, "предмет": "Русский язык", "учитель": "Автоделян Н.Г.", "кабинет": "29"},
            {"урок": 6, "предмет": "Литература", "учитель": "Автоделян Н.Г.", "кабинет": "29"},
            {"урок": 7, "предмет": "Россия - мои горизонты", "учитель": "Бердникова С.С.", "кабинет": "18"}
        ],
        "Пятница": [
            {"урок": 1, "предмет": "Уточните время", "учитель": "", "кабинет": ""}
        ]
    },
    "7А": {
        "Понедельник": [
            {"урок": 1, "предмет": "Разговор о важном", "учитель": "Овакимян Д.О.", "кабинет": "25"},
            {"урок": 2, "предмет": "Русский язык", "учитель": "Смирнова О.И.", "кабинет": "17"},
            {"урок": 3, "предмет": "География", "учитель": "Попова Т.С.", "кабинет": "28"},
            {"урок": 4, "предмет": "История", "учитель": "Бердникова С.С.", "кабинет": "18"},
            {"урок": 5, "предмет": "Англ.яз.", "учитель": "Боровская Ю.В./Смирнова О.И.", "кабинет": "27/17"},
            {"урок": 6, "предмет": "Биология", "учитель": "Макин В.П.", "кабинет": "16"},
            {"урок": 7, "предмет": "Литература", "учитель": "Смирнова О.И.", "кабинет": "17"}
        ],
        "Вторник": [
            {"урок": 1, "предмет": "Физика", "учитель": "Арустамян Ас.А.", "кабинет": "26"},
            {"урок": 2, "предмет": "Русский язык", "учитель": "Смирнова О.И.", "кабинет": "17"},
            {"урок": 3, "предмет": "Физ-ра", "учитель": "Овакимян Д.О.", "кабинет": "Спортзал"},
            {"урок": 4, "предмет": "Геометрия", "учитель": "Арустамян Ан.А.", "кабинет": "31"},
            {"урок": 5, "предмет": "Труд", "учитель": "Пучков И.В.", "кабинет": "30"},
            {"урок": 6, "предмет": "География", "учитель": "Попова Т.С.", "кабинет": "28"},
            {"урок": 7, "предмет": "Русский язык", "учитель": "Смирнова О.И.", "кабинет": "17"}
        ],
        "Среда": [
            {"урок": 1, "предмет": "Вероятность и статистика", "учитель": "Арустамян Ан.А.", "кабинет": "31"},
            {"урок": 2, "предмет": "Алгебра", "учитель": "Арустамян Ан.А.", "кабинет": "31"},
            {"урок": 3, "предмет": "История", "учитель": "Бердникова С.С.", "кабинет": "18"},
            {"урок": 4, "предмет": "Англ.яз./Информатика", "учитель": "Боровская Ю.В./Пучков И.В.", "кабинет": "27/30"},
            {"урок": 5, "предмет": "Информатика/Англ.яз.", "учитель": "Пучков И.В./Смирнова О.И.", "кабинет": "30/17"},
            {"урок": 6, "предмет": "Русский язык", "учитель": "Смирнова О.И.", "кабинет": "17"},
            {"урок": 7, "предмет": "Литература", "учитель": "Смирнова О.И.", "кабинет": "17"}
        ],
        "Четверг": [
            {"урок": 1, "предмет": "Геометрия", "учитель": "Арустамян Ан.А.", "кабинет": "31"},
            {"урок": 2, "предмет": "Алгебра", "учитель": "Арустамян Ан.А.", "кабинет": "31"},
            {"урок": 3, "предмет": "Физ-ра", "учитель": "Овакимян Д.О.", "кабинет": "Спортзал"},
            {"урок": 4, "предмет": "Физика", "учитель": "Арустамян Ас.А.", "кабинет": "26"},
            {"урок": 5, "предмет": "Англ.яз.", "учитель": "Боровская Ю.В./Смирнова О.И.", "кабинет": "27/17"},
            {"урок": 6, "предмет": "Музыка", "учитель": "Пушкарева М.С.", "кабинет": "19"},
            {"урок": 7, "предмет": "Россия - мои горизонты", "учитель": "Овакимян Д.О.", "кабинет": "20"}
        ],
        "Пятница": [
            {"урок": 1, "предмет": "Алгебра", "учитель": "Арустамян Ан.А.", "кабинет": "31"},
            {"урок": 2, "предмет": "Труд", "учитель": "Пучков И.В.", "кабинет": "30"},
            {"урок": 3, "предмет": "Геометрия", "учитель": "Арустамян Ан.А.", "кабинет": "31"},
            {"урок": 4, "предмет": "Русский язык", "учитель": "Смирнова О.И.", "кабинет": "17"},
            {"урок": 5, "предмет": "ИЗО", "учитель": "Пушкарева М.С.", "кабинет": "19"},
            {"урок": 6, "предмет": "История", "учитель": "Бердникова С.С.", "кабинет": "18"}
        ]
    },
    "8А": {
        "Понедельник": [
            {"урок": 1, "предмет": "Разговор о важном", "учитель": "Морозов С.М.", "кабинет": "4"},
            {"урок": 2, "предмет": "Музыка", "учитель": "Пушкарева М.С.", "кабинет": "19"},
            {"урок": 3, "предмет": "Физика", "учитель": "Арустамян Ас.А.", "кабинет": "26"},
            {"урок": 4, "предмет": "Информатика/Англ.яз.", "учитель": "Пучков И.В./Смирнова О.И.", "кабинет": "30/17"},
            {"урок": 5, "предмет": "Геометрия", "учитель": "Арустамян Ас.А.", "кабинет": "26"},
            {"урок": 6, "предмет": "Англ.яз./Информатика", "учитель": "Боровская Ю.В./Пучков И.В.", "кабинет": "27/30"},
            {"урок": 7, "предмет": "Биология", "учитель": "Макин В.П.", "кабинет": "16"}
        ],
        "Вторник": [
            {"урок": 1, "предмет": "Англ.яз.", "учитель": "Боровская Ю.В./Смирнова О.И.", "кабинет": "27/17"},
            {"урок": 2, "предмет": "Алгебра", "учитель": "Арустамян Ас.А.", "кабинет": "26"},
            {"урок": 3, "предмет": "Литература", "учитель": "Стрыжкова И.М.", "кабинет": "29"},
            {"урок": 4, "предмет": "Русский язык", "учитель": "Стрыжкова И.М.", "кабинет": "20"},
            {"урок": 5, "предмет": "История", "учитель": "Морозов С.М.", "кабинет": "4"},
            {"урок": 6, "предмет": "География", "учитель": "Морозов С.М.", "кабинет": "4"},
            {"урок": 7, "предмет": "ОБЖ", "учитель": "Попова Т.С.", "кабинет": "28"}
        ],
        "Среда": [
            {"урок": 1, "предмет": "Биология", "учитель": "Макин В.П.", "кабинет": "16"},
            {"урок": 2, "предмет": "Физ-ра", "учитель": "Рыжикова Н.С.", "кабинет": "Спортзал"},
            {"урок": 3, "предмет": "Информатика/Англ.яз.", "учитель": "Пучков И.В./Смирнова О.И.", "кабинет": "30/17"},
            {"урок": 4, "предмет": "Алгебра", "учитель": "Арустамян Ас.А.", "кабинет": "26"},
            {"урок": 5, "предмет": "Физика", "учитель": "Арустамян Ас.А.", "кабинет": "26"},
            {"урок": 6, "предмет": "Англ.яз./Информатика", "учитель": "Боровская Ю.В./Пучков И.В.", "кабинет": "27/30"},
            {"урок": 7, "предмет": "Химия", "учитель": "Аветисян С.В.", "кабинет": "16"}
        ],
        "Четверг": [
            {"урок": 1, "предмет": "Труд", "учитель": "Осенян А.К.", "кабинет": "13"},
            {"урок": 2, "предмет": "Геометрия", "учитель": "Арустамян Ас.А.", "кабинет": "26"},
            {"урок": 3, "предмет": "Русский язык", "учитель": "Стрыжкова И.М.", "кабинет": "20"},
            {"урок": 4, "предмет": "Литература", "учитель": "Стрыжкова И.М.", "кабинет": "20"},
            {"урок": 5, "предмет": "История", "учитель": "Морозов С.М.", "кабинет": "4"},
            {"урок": 6, "предмет": "География", "учитель": "Морозов С.М.", "кабинет": "4"},
            {"урок": 7, "предмет": "Россия - мои горизонты", "учитель": "Морозов С.М.", "кабинет": "4"}
        ],
        "Пятница": [
            {"урок": 1, "предмет": "Вероятность и статистика", "учитель": "Арустамян Ас.А.", "кабинет": "26"},
            {"урок": 2, "предмет": "Русский язык", "учитель": "Стрыжкова И.М.", "кабинет": "29"},
            {"урок": 3, "предмет": "Геометрия", "учитель": "Арустамян Ас.А.", "кабинет": "26"},
            {"урок": 4, "предмет": "Алгебра", "учитель": "Арустамян Ас.А.", "кабинет": "26"},
            {"урок": 5, "предмет": "Физ-ра", "учитель": "Рыжикова Н.С.", "кабинет": "Спортзал"},
            {"урок": 6, "предмет": "Химия", "учитель": "Аветисян С.В.", "кабинет": "16"},
            {"урок": 7, "предмет": "Обществознание", "учитель": "Бердникова С.С.", "кабинет": "18"}
        ]
    },
    "9А": {
        "Понедельник": [
            {"урок": 1, "предмет": "Разговор о важном", "учитель": "Пушкарева М.С.", "кабинет": "19"},
            {"урок": 2, "предмет": "История", "учитель": "Морозов С.М.", "кабинет": "4"},
            {"урок": 3, "предмет": "Биология", "учитель": "Макин В.П.", "кабинет": "16"},
            {"урок": 4, "предмет": "Англ.яз.", "учитель": "Боровская Ю.В.", "кабинет": "27"},
            {"урок": 5, "предмет": "Алгебра", "учитель": "Арустамян Ан.А.", "кабинет": "31"},
            {"урок": 6, "предмет": "География", "учитель": "Морозов С.М.", "кабинет": "4"},
            {"урок": 7, "предмет": "Физ-ра", "учитель": "Овакимян Д.О.", "кабинет": "Спортзал"}
        ],
        "Вторник": [
            {"урок": 1, "предмет": "Литература", "учитель": "Стрыжкова И.М.", "кабинет": "29"},
            {"урок": 2, "предмет": "Русский язык", "учитель": "Стрыжкова И.М.", "кабинет": "29"},
            {"урок": 3, "предмет": "Алгебра", "учитель": "Арустамян Ан.А.", "кабинет": "31"},
            {"урок": 4, "предмет": "История", "учитель": "Морозов С.М.", "кабинет": "4"},
            {"урок": 5, "предмет": "Физика", "учитель": "Арустамян Ан.А.", "кабинет": "31"},
            {"урок": 6, "предмет": "Геометрия", "учитель": "Арустамян Ас.А.", "кабинет": "26"},
            {"урок": 7, "предмет": "Англ.яз.", "учитель": "Боровская Ю.В.", "кабинет": "27"}
        ],
        "Среда": [
            {"урок": 1, "предмет": "Информатика", "учитель": "Пучков И.В.", "кабинет": "30"},
            {"урок": 2, "предмет": "Биология", "учитель": "Макин В.П.", "кабинет": "16"},
            {"урок": 3, "предмет": "Физика", "учитель": "Арустамян Ан.А.", "кабинет": "31"},
            {"урок": 4, "предмет": "Физика", "учитель": "Арустамян Ан.А.", "кабинет": "31"},
            {"урок": 5, "предмет": "География", "учитель": "Морозов С.М.", "кабинет": "28"},
            {"урок": 6, "предмет": "Химия", "учитель": "Аветисян С.В.", "кабинет": "16"},
            {"урок": 7, "предмет": "История", "учитель": "Морозов С.М.", "кабинет": "4"}
        ],
        "Четверг": [
            {"урок": 1, "предмет": "Литература", "учитель": "Стрыжкова И.М.", "кабинет": "29"},
            {"урок": 2, "предмет": "Русский язык", "учитель": "Стрыжкова И.М.", "кабинет": "29"},
            {"урок": 3, "предмет": "Геометрия", "учитель": "Арустамян Ас.А.", "кабинет": "26"},
            {"урок": 4, "предмет": "Алгебра", "учитель": "Арустамян Ан.А.", "кабинет": "31"},
            {"урок": 5, "предмет": "Труд", "учитель": "Осепян А.К.", "кабинет": "13"},
            {"урок": 6, "предмет": "Физ-ра", "учитель": "Овакимян Д.О.", "кабинет": "Спортзал"},
            {"урок": 7, "предмет": "Россия - мои горизонты", "учитель": "Пушкарева М.С.", "кабинет": "19"}
        ],
        "Пятница": [
            {"урок": 1, "предмет": "Русский язык", "учитель": "Стрыжкова И.М.", "кабинет": "29"},
            {"урок": 2, "предмет": "Вероятность и статистика", "учитель": "Арустамян Ан.А.", "кабинет": "31"},
            {"урок": 3, "предмет": "Литература", "учитель": "Стрыжкова И.М.", "кабинет": "29"},
            {"урок": 4, "предмет": "Англ.яз.", "учитель": "Боровская Ю.В.", "кабинет": "27"},
            {"урок": 5, "предмет": "Обществознание", "учитель": "Бердникова С.С.", "кабинет": "18"},
            {"урок": 6, "предмет": "ОБЖ", "учитель": "Попова Т.С.", "кабинет": "28"},
            {"урок": 7, "предмет": "Химия", "учитель": "Аветисян С.В.", "кабинет": "16"}
        ]
    },
    "10А": {
        "Понедельник": [
            {"урок": 1, "предмет": "Разговор о важном", "учитель": "Смирнова О.И.", "кабинет": "17"},
            {"урок": 2, "предмет": "Геометрия", "учитель": "Арустамян Ан.А.", "кабинет": "31"},
            {"урок": 3, "предмет": "Вероятность и статистика", "учитель": "Арустамян Ан.А.", "кабинет": "31"},
            {"урок": 4, "предмет": "Физика", "учитель": "Арустамян Ас.А.", "кабинет": "26"},
            {"урок": 5, "предмет": "Русский язык", "учитель": "Автоделян Н.Г.", "кабинет": "29"},
            {"урок": 6, "предмет": "Практическая физика", "учитель": "Арустамян Ас.А.", "кабинет": "26"},
            {"урок": 7, "предмет": "Информатика", "учитель": "Пучков И.В.", "кабинет": "30"}
        ],
        "Вторник": [
            {"урок": 1, "предмет": "Обществознание", "учитель": "Морозов С.М.", "кабинет": "4"},
            {"урок": 2, "предмет": "География", "учитель": "Морозов С.М.", "кабинет": "28"},
            {"урок": 3, "предмет": "Алгебра", "учитель": "Арустамян Ас.А.", "кабинет": "26"},
            {"урок": 4, "предмет": "Литература", "учитель": "Автоделян Н.Г.", "кабинет": "29"},
            {"урок": 5, "предмет": "Физ-ра", "учитель": "Овакимян Д.О.", "кабинет": "Спортзал"},
            {"урок": 6, "предмет": "Англ.яз.", "учитель": "Смирнова О.И.", "кабинет": "17"},
            {"урок": 7, "предмет": "Информатика", "учитель": "Пучков И.В.", "кабинет": "30"}
        ],
        "Среда": [
            {"урок": 1, "предмет": "Обществознание", "учитель": "Морозов С.М.", "кабинет": "4"},
            {"урок": 2, "предмет": "Физика", "учитель": "Арустамян Ас.А.", "кабинет": "26"},
            {"урок": 3, "предмет": "История", "учитель": "Морозов С.М.", "кабинет": "4"},
            {"урок": 4, "предмет": "Обществознание", "учитель": "Морозов С.М.", "кабинет": "4"},
            {"урок": 5, "предмет": "Биология", "учитель": "Макин В.П.", "кабинет": "20"},
            {"урок": 6, "предмет": "Литература", "учитель": "Автоделян Н.Г.", "кабинет": "29"},
            {"урок": 7, "предмет": "Литература", "учитель": "Автоделян Н.Г.", "кабинет": "29"}
        ],
        "Четверг": [
            {"урок": 1, "предмет": "Обществознание", "учитель": "Морозов С.М.", "кабинет": "4"},
            {"урок": 2, "предмет": "Индивидуальный проект", "учитель": "Осепян А.К.", "кабинет": "13"},
            {"урок": 3, "предмет": "Литература", "учитель": "Автоделян Н.Г.", "кабинет": "29"},
            {"урок": 4, "предмет": "История", "учитель": "Морозов С.М.", "кабинет": "4"},
            {"урок": 5, "предмет": "Геометрия", "учитель": "Арустамян Ан.А.", "кабинет": "31"},
            {"урок": 6, "предмет": "Англ.яз.", "учитель": "Смирнова О.И.", "кабинет": "17"},
            {"урок": 7, "предмет": "Англ.яз.", "учитель": "Смирнова О.И.", "кабинет": "17"},
            {"урок": 8, "предмет": "Россия - мои горизонты", "учитель": "Смирнова О.И.", "кабинет": "17"}
        ],
        "Пятница": [
            {"урок": 1, "предмет": "ОБЖ", "учитель": "Попова Т.С.", "кабинет": "28"},
            {"урок": 2, "предмет": "Алгебра", "учитель": "Арустамян Ас.А.", "кабинет": "26"},
            {"урок": 3, "предмет": "Разговорный английский", "учитель": "Боровская Ю.В.", "кабинет": "27"},
            {"урок": 4, "предмет": "Русский язык", "учитель": "Автоделян Н.Г.", "кабинет": "29"},
            {"урок": 5, "предмет": "Химия", "учитель": "Аветисян С.В.", "кабинет": "16"},
            {"урок": 6, "предмет": "Литература", "учитель": "Автоделян Н.Г.", "кабинет": "29"},
            {"урок": 7, "предмет": "Физ-ра", "учитель": "Овакимян Д.О.", "кабинет": "Спортзал"}
        ]
    },
    "11А": {
        "Понедельник": [
            {"урок": 1, "предмет": "Разговор о важном", "учитель": "Автоделян Н.Г.", "кабинет": "29"},
            {"урок": 2, "предмет": "Литература", "учитель": "Автоделян Н.Г.", "кабинет": "29"},
            {"урок": 3, "предмет": "Обществознание", "учитель": "Морозов С.М.", "кабинет": "4"},
            {"урок": 4, "предмет": "Биология", "учитель": "Макин В.П.", "кабинет": "20"},
            {"урок": 5, "предмет": "История", "учитель": "Морозов С.М.", "кабинет": "4"},
            {"урок": 6, "предмет": "Физика", "учитель": "Арустамян Ан.А.", "кабинет": "31"},
            {"урок": 7, "предмет": "Разговорный английский", "учитель": "Боровская Ю.В.", "кабинет": "27"}
        ],
        "Вторник": [
            {"урок": 1, "предмет": "Геометрия", "учитель": "Арустамян Ан.А.", "кабинет": "31"},
            {"урок": 2, "предмет": "Физ-ра", "учитель": "Овакимян Д.О.", "кабинет": "Спортзал"},
            {"урок": 3, "предмет": "Обществознание", "учитель": "Морозов С.М.", "кабинет": "4"},
            {"урок": 4, "предмет": "Алгебра", "учитель": "Арустамян Ас.А.", "кабинет": "26"},
            {"урок": 5, "предмет": "Русский язык", "учитель": "Автоделян Н.Г.", "кабинет": "29"},
            {"урок": 6, "предмет": "Вероятность и статистика", "учитель": "Арустамян Ан.А.", "кабинет": "31"},
            {"урок": 7, "предмет": "География", "учитель": "Морозов С.М.", "кабинет": "4"}
        ],
        "Среда": [
            {"урок": 1, "предмет": "Англ.яз.", "учитель": "Боровская Ю.В.", "кабинет": "27"},
            {"урок": 2, "предмет": "Обществознание", "учитель": "Морозов С.М.", "кабинет": "4"},
            {"урок": 3, "предмет": "Алгебра", "учитель": "Арустамян Ас.А.", "кабинет": "26"},
            {"урок": 4, "предмет": "Литература", "учитель": "Автоделян Н.Г.", "кабинет": "29"},
            {"урок": 5, "предмет": "Химия", "учитель": "Аветисян С.В.", "кабинет": "16"},
            {"урок": 6, "предмет": "Физика", "учитель": "Арустамян Ан.А.", "кабинет": "31"},
            {"урок": 7, "предмет": "Информатика", "учитель": "Пучков И.В.", "кабинет": "30"}
        ],
        "Четверг": [
            {"урок": 1, "предмет": "Англ.яз.", "учитель": "Боровская Ю.В.", "кабинет": "27"},
            {"урок": 2, "предмет": "Обществознание", "учитель": "Морозов С.М.", "кабинет": "4"},
            {"урок": 3, "предмет": "История", "учитель": "Морозов С.М.", "кабинет": "4"},
            {"урок": 4, "предмет": "Литература", "учитель": "Автоделян Н.Г.", "кабинет": "29"},
            {"урок": 5, "предмет": "Алгебра", "учитель": "Арустамян Ас.А.", "кабинет": "26"},
            {"урок": 6, "предмет": "Индивидуальный проект", "учитель": "Осенян А.К.", "кабинет": "13"},
            {"урок": 7, "предмет": "Информатика", "учитель": "Пучков И.В.", "кабинет": "30"},
            {"урок": 8, "предмет": "Россия - мои горизонты", "учитель": "Автоделян Н.Г.", "кабинет": "29"}
        ],
        "Пятница": [
            {"урок": 1, "предмет": "Англ.яз.", "учитель": "Боровская Ю.В.", "кабинет": "27"},
            {"урок": 2, "предмет": "Русский язык", "учитель": "Автоделян Н.Г.", "кабинет": "20"},
            {"урок": 3, "предмет": "ОБЖ", "учитель": "Попова Т.С.", "кабинет": "28"},
            {"урок": 4, "предмет": "Практическая физика", "учитель": "Арустамян Ан.А.", "кабинет": "31"},
            {"урок": 5, "предмет": "Литература", "учитель": "Автоделян Н.Г.", "кабинет": "29"},
            {"урок": 6, "предмет": "Физ-ра", "учитель": "Овакимян Д.О.", "кабинет": "Спортзал"},
            {"урок": 7, "предмет": "Литература", "учитель": "Автоделян Н.Г.", "кабинет": "29"},
        ]
    },
}

DATA_STORE_FILE = "data_store.py"

DEFAULT_DATA_SOURCE = """# data_store.py
USERS = {}
NEWS = []
EVENTS = []
REPLACEMENTS = []
"""

def ensure_data_store():
    if not os.path.exists(DATA_STORE_FILE):
        with open(DATA_STORE_FILE, "w", encoding="utf-8") as f:
            f.write(DEFAULT_DATA_SOURCE)

def load_data_store() -> Dict[str, Any]:
    ensure_data_store()
    g = {}
    with open(DATA_STORE_FILE, "r", encoding="utf-8") as f:
        code = f.read()
    exec(code, g)
    return {
        "USERS": g.get("USERS", {}),
        "NEWS": g.get("NEWS", []),
        "EVENTS": g.get("EVENTS", []),
        "REPLACEMENTS": g.get("REPLACEMENTS", [])
    }

def save_data_store(users: Dict, news: List, events: List, replacements: List):
    text = "# data_store.py\n"
    text += "# Автоматически сохранено ботом. Не редактируйте во время работы.\n"

    text += "USERS = {\n"
    for k, v in users.items():
        role = v.get("role", "")
        klass = v.get("class", "")
        teacher = v.get("teacher", "")
        fields = [f"'role': {repr(role)}"]
        if klass: fields.append(f"'class': {repr(klass)}")
        if teacher: fields.append(f"'teacher': {repr(teacher)}")
        text += f"    {repr(k)}: {{{', '.join(fields)}}},\n"
    text += "}\n"

    text += "NEWS = [\n"
    for item in news:
        text += f"    {repr(item)},\n"
    text += "]\n"

    text += "EVENTS = [\n"
    for item in events:
        text += f"    {repr(item)},\n"
    text += "]\n"

    text += "REPLACEMENTS = [\n"
    for r in replacements:
        text += f"    {repr(r)},\n"
    text += "]\n"

    fd, tmp_path = tempfile.mkstemp(prefix="data_store_", suffix=".py", dir=".")
    os.close(fd)
    with open(tmp_path, "w", encoding="utf-8") as f:
        f.write(text)
    os.replace(tmp_path, DATA_STORE_FILE)

data = load_data_store()
USERS = data["USERS"]
NEWS = data["NEWS"]
EVENTS = data["EVENTS"]
REPLACEMENTS = data["REPLACEMENTS"]

def get_all_teachers() -> List[str]:
    teachers = set()
    for klass_data in SCHEDULE.values():
        for day_lessons in klass_data.values():
            for lesson in day_lessons:
                t = lesson.get("учитель", "").strip()
                if t and t != "—" and t != "":
                    for part in t.split("/"):
                        cleaned = part.strip().split(",")[0].split("(")[0].strip()
                        if cleaned:
                            teachers.add(cleaned)
    return sorted(teachers)

def main_menu(is_admin=False):
    buttons = [
        [InlineKeyboardButton("📅 Расписание", callback_data="sched")],
        [InlineKeyboardButton("🔁 Замены уроков", callback_data="replacements")],
        [InlineKeyboardButton("⏰ Расписание звонков", callback_data="bells")],
        [InlineKeyboardButton("📢 Новости школы", callback_data="news")],
        [InlineKeyboardButton("🎉 Мероприятия", callback_data="events")],
        [InlineKeyboardButton("📞 О школе", callback_data="contacts")],
        [InlineKeyboardButton("⚙️ Настройки", callback_data="settings")]
    ]
    if is_admin:
        buttons.append([InlineKeyboardButton("👑 Админка", callback_data="admin")])
    return InlineKeyboardMarkup(buttons)

def role_kb():
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("🧑‍🎓 Ученик", callback_data="role_ученик")],
        [InlineKeyboardButton("👨‍👩‍👧 Родитель", callback_data="role_родитель")],
        [InlineKeyboardButton("👩‍🏫 Учитель", callback_data="role_учитель")],
    ])

def class_kb():
    classes = [f"{i}А" for i in range(1, 12)]
    buttons = [[InlineKeyboardButton(c, callback_data=f"class_{c}")] for c in classes]
    buttons.append([InlineKeyboardButton("🔙 Назад", callback_data="back_to_role")])
    return InlineKeyboardMarkup(buttons)

def teacher_kb():
    teachers = get_all_teachers()
    buttons = [[InlineKeyboardButton(t, callback_data=f"teacher_{t}")] for t in teachers]
    buttons.append([InlineKeyboardButton("🔙 Назад", callback_data="back_to_role")])
    return InlineKeyboardMarkup(buttons)

def day_kb(klass):
    days = ["Понедельник", "Вторник", "Среда", "Четверг", "Пятница"]
    buttons = [[InlineKeyboardButton(d, callback_data=f"day_{klass}_{d}")] for d in days]
    buttons.append([InlineKeyboardButton("🔙 В меню", callback_data="main")])
    return InlineKeyboardMarkup(buttons)

def teacher_day_kb(teacher):
    # Соберём дни, где учитель ведёт уроки
    days_set = set()
    for klass, klass_data in SCHEDULE.items():
        for day, lessons in klass_data.items():
            for lesson in lessons:
                t = lesson.get("учитель", "")
                if teacher in [part.strip() for part in t.split("/")]:
                    days_set.add(day)
    days = sorted(days_set, key=lambda d: ["Понедельник", "Вторник", "Среда", "Четверг", "Пятница"].index(d))
    buttons = [[InlineKeyboardButton(d, callback_data=f"tday_{teacher}_{d}")] for d in days]
    buttons.append([InlineKeyboardButton("🔙 В меню", callback_data="main")])
    return InlineKeyboardMarkup(buttons)

def lessons_kb(klass, day, lessons, is_teacher=False, teacher_name=""):
    kb = []
    for idx, lesson in enumerate(lessons):
        lesson_num = lesson.get("урок", "?")
        subject = lesson.get("предмет", "")
        if is_teacher:
            label = f"{klass} | Урок {lesson_num} — {subject}"
            cb = f"tlesson_{teacher_name}_{day}_{idx}"
        else:
            label = f"Урок {lesson_num} — {subject}"
            cb = f"lesson_{klass}_{day}_{idx}"
        kb.append([InlineKeyboardButton(label, callback_data=cb)])
    if is_teacher:
        kb.append([InlineKeyboardButton("🔙 К дням", callback_data=f"t_days_for_{teacher_name}")])
    else:
        kb.append([InlineKeyboardButton("🔙 К дням", callback_data=f"sched_for_{klass}")])
    kb.append([InlineKeyboardButton("🔙 В меню", callback_data="main")])
    return InlineKeyboardMarkup(kb)

def back_to_main():
    return InlineKeyboardMarkup([[InlineKeyboardButton("🔙 В меню", callback_data="main")]])

# ========== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ==========
def is_admin_user(uid: int) -> bool:
    return uid in ADMINS

def get_teacher_schedule(teacher_name: str) -> Dict[str, List[Dict]]:
    result = {}
    for klass, days in SCHEDULE.items():
        for day, lessons in days.items():
            matched = []
            for lesson in lessons:
                t = lesson.get("учитель", "")
                for part in t.split("/"):
                    if teacher_name == part.strip():
                        l_copy = lesson.copy()
                        l_copy["класс"] = klass
                        matched.append(l_copy)
            if matched:
                if day not in result:
                    result[day] = []
                result[day].extend(matched)
    for day in result:
        result[day].sort(key=lambda x: x.get("урок", 0))
    return result

def apply_replacement(lesson: Dict, klass: str, day: str) -> Dict:
    """Возвращает урок с применённой заменой (если есть)."""
    lesson = lesson.copy()
    for repl in REPLACEMENTS:
        if (
            repl.get("class") == klass and
            repl.get("day") == day and
            repl.get("урок") == lesson.get("урок")
        ):
            lesson["предмет"] = repl.get("предмет", lesson.get("предмет"))
            lesson["учитель"] = repl.get("учитель", lesson.get("учитель"))
            lesson["кабинет"] = repl.get("кабинет", lesson.get("кабинет"))
            lesson["замена"] = True
            break
    return lesson

# ========== ХЕНДЛЕРЫ ==========
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = str(update.effective_user.id)
    admin = is_admin_user(update.effective_user.id)
    if chat_id in USERS:
        await update.message.reply_text("🎓 С возвращением в школу №259!", reply_markup=main_menu(admin))
    else:
        await update.message.reply_text("👋 Добро пожаловать! Кто вы?", reply_markup=role_kb())

async def reset_settings(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = str(update.effective_user.id)
    if chat_id in USERS:
        USERS.pop(chat_id, None)
        save_data_store(USERS, NEWS, EVENTS, REPLACEMENTS)
        await update.message.reply_text("⚙️ Настройки сброшены. Выполните /start снова.")
    else:
        await update.message.reply_text("У вас ещё нет сохранённых настроек.")

async def whoami(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = str(update.effective_user.id)
    u = USERS.get(chat_id, {})
    if not u:
        await update.message.reply_text("Вы ещё не выбрали роль. Выполните /start")
        return
    role = u.get("role", "—")
    klass = u.get("class", "—")
    teacher = u.get("teacher", "—")
    text = f"👤 Информация:\nРоль: {role}\nКласс: {klass}\nУчитель: {teacher}"
    await update.message.reply_text(text)

async def callback_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    data_cb = query.data
    chat_id = str(query.from_user.id)
    admin_flag = is_admin_user(query.from_user.id)

    # === РОЛЬ / КЛАСС / УЧИТЕЛЬ ===
    if data_cb == "back_to_role":
        await query.edit_message_text("Кто вы?", reply_markup=role_kb())
        return

    if data_cb.startswith("role_"):
        role = data_cb.split("_", 1)[1]
        USERS.setdefault(chat_id, {})["role"] = role
        save_data_store(USERS, NEWS, EVENTS, REPLACEMENTS)
        if role == "учитель":
            await query.edit_message_text("Выберите себя из списка:", reply_markup=teacher_kb())
        else:
            await query.edit_message_text("Выберите класс:", reply_markup=class_kb())
        return

    if data_cb.startswith("class_"):
        klass = data_cb.split("_", 1)[1]
        u = USERS.setdefault(chat_id, {})
        u["class"] = klass
        u.pop("teacher", None)
        save_data_store(USERS, NEWS, EVENTS, REPLACEMENTS)
        await query.edit_message_text("✅ Настройки сохранены!\nГлавное меню:", reply_markup=main_menu(admin_flag))
        return

    if data_cb.startswith("teacher_"):
        teacher = data_cb.split("_", 1)[1]
        u = USERS.setdefault(chat_id, {})
        u["teacher"] = teacher
        u.pop("class", None)
        save_data_store(USERS, NEWS, EVENTS, REPLACEMENTS)
        await query.edit_message_text(f"✅ Учитель: {teacher}\nГлавное меню:", reply_markup=main_menu(admin_flag))
        return

    # === ГЛАВНОЕ МЕНЮ ===
    if data_cb == "main":
        await query.edit_message_text("Главное меню:", reply_markup=main_menu(admin_flag))
        return

    # === РАСПИСАНИЕ ===
    if data_cb == "sched":
        u = USERS.get(chat_id)
        if not u or not u.get("role"):
            await query.edit_message_text("❗ Сначала выберите роль в настройках.", reply_markup=back_to_main())
            return

        role = u["role"]
        if role in ("ученик", "родитель"):
            klass = u.get("class")
            if not klass:
                await query.edit_message_text("❗ Выберите класс в настройках.", reply_markup=back_to_main())
                return
            await query.edit_message_text(f"📅 Расписание для {klass}\nВыберите день:", reply_markup=day_kb(klass))
        elif role == "учитель":
            teacher = u.get("teacher")
            if not teacher:
                await query.edit_message_text("❗ Выберите себя в настройках.", reply_markup=back_to_main())
                return
            await query.edit_message_text(f"📅 Расписание для {teacher}\nВыберите день:", reply_markup=teacher_day_kb(teacher))
        return

    if data_cb.startswith("sched_for_"):
        klass = data_cb.split("_", 2)[2]
        await query.edit_message_text(f"📅 Расписание для {klass}\nВыберите день:", reply_markup=day_kb(klass))
        return

    if data_cb.startswith("t_days_for_"):
        teacher = data_cb.split("_", 3)[3]
        await query.edit_message_text(f"📅 Расписание для {teacher}\nВыберите день:", reply_markup=teacher_day_kb(teacher))
        return

    # === УРОКИ ПО КЛАССУ ===
    if data_cb.startswith("day_"):
        try:
            _, klass, day = data_cb.split("_", 2)
        except ValueError:
            await query.edit_message_text("❌ Ошибка дня.", reply_markup=back_to_main())
            return
        lessons = SCHEDULE.get(klass, {}).get(day, [])
        if not lessons:
            await query.edit_message_text(f"{klass} — {day}\nУроков нет.", reply_markup=back_to_main())
            return
        await query.edit_message_text(f"{klass} — {day}\nВыберите урок:", reply_markup=lessons_kb(klass, day, lessons))
        return

    if data_cb.startswith("lesson_"):
        try:
            _, klass, day, idx_str = data_cb.split("_", 3)
            idx = int(idx_str)
        except Exception:
            await query.edit_message_text("❌ Ошибка урока.", reply_markup=back_to_main())
            return
        lessons = SCHEDULE.get(klass, {}).get(day, [])
        if idx < 0 or idx >= len(lessons):
            await query.edit_message_text("❌ Урок не найден.", reply_markup=back_to_main())
            return
        lesson = apply_replacement(lessons[idx], klass, day)
        lesson_num = str(lesson.get("урок", ""))
        time_str = CALL_SCHEDULE.get(lesson_num, "—")
        text = (
            f"<b>{html.escape(klass)} — {html.escape(day)}</b>\n"
            f"Урок: <b>{lesson.get('урок')}</b>\n"
            f"Предмет: {html.escape(lesson.get('предмет', '—'))}\n"
            f"Учитель: {html.escape(lesson.get('учитель', '—'))}\n"
            f"Кабинет: {html.escape(lesson.get('кабинет', '—'))}\n"
            f"Время: {time_str}"
        )
        if lesson.get("замена"):
            text = "🔔 <b>ЗАМЕНА</b>\n" + text
        await query.edit_message_text(text, parse_mode="HTML", reply_markup=back_to_main())
        return

    # === УРОКИ ПО УЧИТЕЛЮ ===
    if data_cb.startswith("tday_"):
        try:
            _, teacher, day = data_cb.split("_", 2)
        except ValueError:
            await query.edit_message_text("❌ Ошибка дня учителя.", reply_markup=back_to_main())
            return
        schedule_dict = get_teacher_schedule(teacher)
        lessons = schedule_dict.get(day, [])
        if not lessons:
            await query.edit_message_text(f"{teacher} — {day}\nУроков нет.", reply_markup=back_to_main())
            return
        await query.edit_message_text(f"{teacher} — {day}\nВыберите урок:", reply_markup=lessons_kb("", day, lessons, is_teacher=True, teacher_name=teacher))
        return

    if data_cb.startswith("tlesson_"):
        try:
            _, teacher, day, idx_str = data_cb.split("_", 3)
            idx = int(idx_str)
        except Exception:
            await query.edit_message_text("❌ Ошибка урока учителя.", reply_markup=back_to_main())
            return
        schedule_dict = get_teacher_schedule(teacher)
        lessons = schedule_dict.get(day, [])
        if idx < 0 or idx >= len(lessons):
            await query.edit_message_text("❌ Урок не найден.", reply_markup=back_to_main())
            return
        lesson = lessons[idx]
        klass = lesson.get("класс", "?")
        # Применяем замену для этого класса+дня+урока
        base_lessons = SCHEDULE.get(klass, {}).get(day, [])
        base_lesson = None
        for l in base_lessons:
            if l.get("урок") == lesson.get("урок"):
                base_lesson = l
                break
        if base_lesson:
            lesson = apply_replacement(base_lesson, klass, day)
        else:
            lesson = lesson.copy()

        lesson_num = str(lesson.get("урок", ""))
        time_str = CALL_SCHEDULE.get(lesson_num, "—")
        text = (
            f"<b>{html.escape(teacher)} — {html.escape(day)}</b>\n"
            f"Класс: <b>{klass}</b>\n"
            f"Урок: <b>{lesson.get('урок')}</b>\n"
            f"Предмет: {html.escape(lesson.get('предмет', '—'))}\n"
            f"Кабинет: {html.escape(lesson.get('кабинет', '—'))}\n"
            f"Время: {time_str}"
        )
        if lesson.get("замена"):
            text = "🔔 <b>ЗАМЕНА</b>\n" + text
        await query.edit_message_text(text, parse_mode="HTML", reply_markup=back_to_main())
        return

    # === ЗАМЕНЫ ===
    if data_cb == "replacements":
        if not REPLACEMENTS:
            await query.edit_message_text("🔁 Актуальных замен нет.", reply_markup=back_to_main())
            return
        text = "🔁 Замены уроков:\n\n"
        for i, r in enumerate(REPLACEMENTS, 1):
            text += (
                f"{i}. <b>{r.get('class')}</b> | {r.get('day')} | Урок {r.get('урок')}\n"
                f"   → {r.get('предмет')} ({r.get('учитель')}, каб. {r.get('кабинет')})\n\n"
            )
        await query.edit_message_text(text, parse_mode="HTML", reply_markup=back_to_main())
        return

    # === ЗВОНКИ ===
    if data_cb == "bells":
        bells_text = "\n".join(f"{k} урок — {v}" for k, v in CALL_SCHEDULE.items())
        await query.edit_message_text(
            f"⏰ Расписание звонков:\n\n{html.escape(bells_text)}",
            reply_markup=back_to_main()
        )
        return

    # === КОНТАКТЫ ===
    if data_cb == "contacts":
        info = (
            f"📞 <b>Школа №259 им. М.Т. Лорис-Меликова</b>\n\n"
            f"📍 Адрес: {SCHOOL_INFO['address']}\n"
            f"📞 Телефон: {SCHOOL_INFO['phone']}\n"
            f"✉️ Email: {SCHOOL_INFO['email']}\n"
            f"👩‍🏫 Директор: {SCHOOL_INFO['director']}"
        )
        await query.edit_message_text(info, parse_mode="HTML", reply_markup=back_to_main())
        return

    # === НОВОСТИ ===
    if data_cb == "news":
        if not NEWS:
            await query.edit_message_text("📰 Новостей пока нет.", reply_markup=back_to_main())
            return
        text = "📰 Последние новости:\n\n"
        for i, item in enumerate(reversed(NEWS[-5:]), 1):
            text += f"{i}. {item}\n\n"
        await query.edit_message_text(text, reply_markup=back_to_main())
        return

    # === МЕРОПРИЯТИЯ ===
    if data_cb == "events":
        if not EVENTS:
            await query.edit_message_text("🎉 Мероприятий пока нет.", reply_markup=back_to_main())
            return
        text = "🎉 Ближайшие мероприятия:\n\n"
        for i, item in enumerate(reversed(EVENTS[-5:]), 1):
            text += f"{i}. {item}\n\n"
        await query.edit_message_text(text, reply_markup=back_to_main())
        return

    # === НАСТРОЙКИ ===
    if data_cb == "settings":
        u = USERS.get(chat_id, {})
        role = u.get("role", "—")
        klass = u.get("class", "—")
        teacher = u.get("teacher", "—")
        text = (
            f"⚙️ <b>Настройки</b>\n\n"
            f"Роль: {role}\n"
            f"Класс: {klass}\n"
            f"Учитель: {teacher}\n\n"
            f"Команды:\n/reset_settings — сброс\n/whoami — инфо"
        )
        kb = [
            [InlineKeyboardButton("🔁 Изменить роль", callback_data="back_to_role")],
            [InlineKeyboardButton("🔙 В меню", callback_data="main")]
        ]
        await query.edit_message_text(text, parse_mode="HTML", reply_markup=InlineKeyboardMarkup(kb))
        return

    # === АДМИНКА ===
    if data_cb == "admin":
        if not admin_flag:
            await query.edit_message_text("❌ Доступ запрещён.", reply_markup=back_to_main())
            return
        keyboard = [
            [InlineKeyboardButton("➕ Добавить новость", callback_data="admin_add_news")],
            [InlineKeyboardButton("📝 Добавить мероприятие", callback_data="admin_add_event")],
            [InlineKeyboardButton("🔁 Добавить замену", callback_data="admin_add_replacement")],
            [InlineKeyboardButton("🗂️ Управление", callback_data="admin_manage")],
            [InlineKeyboardButton("🔙 Назад", callback_data="main")]
        ]
        await query.edit_message_text("👑 Админ-панель:", reply_markup=InlineKeyboardMarkup(keyboard))
        return

    # === УПРАВЛЕНИЕ (новости/события/замены) ===
    if data_cb == "admin_manage":
        await query.edit_message_text("Выберите раздел для управления:", reply_markup=InlineKeyboardMarkup([
            [InlineKeyboardButton("📰 Новости", callback_data="admin_list_news")],
            [InlineKeyboardButton("🎉 Мероприятия", callback_data="admin_list_events")],
            [InlineKeyboardButton("🔁 Замены", callback_data="admin_list_replacements")],
            [InlineKeyboardButton("🔙 Назад", callback_data="admin")]
        ]))
        return

    # === УПРАВЛЕНИЕ НОВОСТЯМИ ===
    if data_cb == "admin_list_news":
        if not NEWS:
            await query.edit_message_text("Нет новостей.", reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("🔙 Назад", callback_data="admin_manage")]]))
            return
        buttons = []
        for i, item in enumerate(NEWS):
            short = (item[:25] + "…") if len(item) > 25 else item
            buttons.append([
                InlineKeyboardButton("❌", callback_data=f"del_news_{i}"),
                InlineKeyboardButton(short, callback_data=f"edit_news_{i}")
            ])
        buttons.append([InlineKeyboardButton("➕ Добавить", callback_data="admin_add_news")])
        buttons.append([InlineKeyboardButton("🔙 Назад", callback_data="admin_manage")])
        await query.edit_message_text("📰 Новости:", reply_markup=InlineKeyboardMarkup(buttons))
        return

    if data_cb.startswith("del_news_"):
        idx = int(data_cb.split("_")[2])
        if 0 <= idx < len(NEWS):
            removed = NEWS.pop(idx)
            save_data_store(USERS, NEWS, EVENTS, REPLACEMENTS)
            await query.answer(f"✅ Удалено: {removed[:30]}…")
        await query.edit_message_text("✅ Удалено.", reply_markup=back_to_main())
        return

    if data_cb.startswith("edit_news_"):
        idx = int(data_cb.split("_")[2])
        context.user_data["admin_action"] = "edit_news"
        context.user_data["edit_idx"] = idx
        await query.edit_message_text(f"✏️ Редактируется новость #{idx+1}.\nОтправьте новый текст.")
        return

    # === УПРАВЛЕНИЕ МЕРОПРИЯТИЯМИ ===
    if data_cb == "admin_list_events":
        if not EVENTS:
            await query.edit_message_text("Нет мероприятий.", reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("🔙 Назад", callback_data="admin_manage")]]))
            return
        buttons = []
        for i, item in enumerate(EVENTS):
            short = (item[:25] + "…") if len(item) > 25 else item
            buttons.append([
                InlineKeyboardButton("❌", callback_data=f"del_event_{i}"),
                InlineKeyboardButton(short, callback_data=f"edit_event_{i}")
            ])
        buttons.append([InlineKeyboardButton("➕ Добавить", callback_data="admin_add_event")])
        buttons.append([InlineKeyboardButton("🔙 Назад", callback_data="admin_manage")])
        await query.edit_message_text("🎉 Мероприятия:", reply_markup=InlineKeyboardMarkup(buttons))
        return

    if data_cb.startswith("del_event_"):
        idx = int(data_cb.split("_")[2])
        if 0 <= idx < len(EVENTS):
            removed = EVENTS.pop(idx)
            save_data_store(USERS, NEWS, EVENTS, REPLACEMENTS)
            await query.answer(f"✅ Удалено: {removed[:30]}…")
        await query.edit_message_text("✅ Удалено.", reply_markup=back_to_main())
        return

    if data_cb.startswith("edit_event_"):
        idx = int(data_cb.split("_")[2])
        context.user_data["admin_action"] = "edit_event"
        context.user_data["edit_idx"] = idx
        await query.edit_message_text(f"✏️ Редактируется мероприятие #{idx+1}.\nОтправьте новый текст (дата + описание).")
        return

    # === УПРАВЛЕНИЕ ЗАМЕНАМИ ===
    if data_cb == "admin_list_replacements":
        if not REPLACEMENTS:
            await query.edit_message_text("Нет замен.", reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("🔙 Назад", callback_data="admin_manage")]]))
            return
        buttons = []
        for i, r in enumerate(REPLACEMENTS):
            label = f"{r.get('class')} | {r.get('day')} | Урок {r.get('урок')}"
            buttons.append([
                InlineKeyboardButton("❌", callback_data=f"del_repl_{i}"),
                InlineKeyboardButton(label[:30], callback_data=f"edit_repl_{i}")
            ])
        buttons.append([InlineKeyboardButton("➕ Добавить", callback_data="admin_add_replacement")])
        buttons.append([InlineKeyboardButton("🔙 Назад", callback_data="admin_manage")])
        await query.edit_message_text("🔁 Замены:", reply_markup=InlineKeyboardMarkup(buttons))
        return

    if data_cb.startswith("del_repl_"):
        idx = int(data_cb.split("_")[2])
        if 0 <= idx < len(REPLACEMENTS):
            removed = REPLACEMENTS.pop(idx)
            save_data_store(USERS, NEWS, EVENTS, REPLACEMENTS)
            await query.answer(f"✅ Замена удалена.")
        await query.edit_message_text("✅ Удалено.", reply_markup=back_to_main())
        return

    if data_cb.startswith("edit_repl_"):
        idx = int(data_cb.split("_")[2])
        context.user_data["admin_action"] = "edit_replacement"
        context.user_data["edit_idx"] = idx
        await query.edit_message_text(
            "✏️ Редактируется замена.\n"
            "Отправьте в формате:\nКласс;День;Номер урока;Новый предмет;Учитель;Кабинет"
        )
        return

    # === ДОБАВЛЕНИЕ ЧЕРЕЗ АДМИНКУ ===
    if data_cb == "admin_add_news":
        if not admin_flag:
            await query.edit_message_text("❌ Доступ запрещён.", reply_markup=back_to_main())
            return
        context.user_data["admin_action"] = "add_news"
        await query.edit_message_text("✏️ Отправьте текст новости.")
        return

    if data_cb == "admin_add_event":
        if not admin_flag:
            await query.edit_message_text("❌ Доступ запрещён.", reply_markup=back_to_main())
            return
        context.user_data["admin_action"] = "add_event"
        await query.edit_message_text("✏️ Отправьте текст мероприятия (дата + описание).")
        return

    if data_cb == "admin_add_replacement":
        if not admin_flag:
            await query.edit_message_text("❌ Доступ запрещён.", reply_markup=back_to_main())
            return
        context.user_data["admin_action"] = "add_replacement"
        await query.edit_message_text(
            "✏️ Отправьте замену в формате:\n"
            "<code>Класс;День;Номер урока;Новый предмет;Учитель;Кабинет</code>",
            parse_mode="HTML"
        )
        return

    # fallback
    await query.edit_message_text("Неизвестная команда.", reply_markup=main_menu(admin_flag))

async def text_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    uid = update.effective_user.id
    if not is_admin_user(uid):
        await update.message.reply_text("Я не обрабатываю текст от не-админов. Пользуйтесь кнопками.")
        return

    action = context.user_data.get("admin_action")
    if not action:
        await update.message.reply_text("Не выбрано действие. Откройте админ-панель → Управление.")
        return

    text = update.message.text.strip()

    if action == "add_news":
        NEWS.append(text)
        save_data_store(USERS, NEWS, EVENTS, REPLACEMENTS)
        context.user_data.pop("admin_action", None)
        await update.message.reply_text("✅ Новость добавлена.")
        return

    if action == "edit_news":
        idx = context.user_data.get("edit_idx")
        if idx is not None and 0 <= idx < len(NEWS):
            NEWS[idx] = text
            save_data_store(USERS, NEWS, EVENTS, REPLACEMENTS)
            context.user_data.pop("admin_action", None)
            context.user_data.pop("edit_idx", None)
            await update.message.reply_text("✅ Новость обновлена.")
        return

    if action == "add_event":
        EVENTS.append(text)
        save_data_store(USERS, NEWS, EVENTS, REPLACEMENTS)
        context.user_data.pop("admin_action", None)
        await update.message.reply_text("✅ Мероприятие добавлено.")
        return

    if action == "edit_event":
        idx = context.user_data.get("edit_idx")
        if idx is not None and 0 <= idx < len(EVENTS):
            EVENTS[idx] = text
            save_data_store(USERS, NEWS, EVENTS, REPLACEMENTS)
            context.user_data.pop("admin_action", None)
            context.user_data.pop("edit_idx", None)
            await update.message.reply_text("✅ Мероприятие обновлено.")
        return

    if action == "add_replacement":
        parts = [p.strip() for p in text.split(";")]
        if len(parts) < 6:
            await update.message.reply_text("❌ Неверный формат.\nИспользуйте: <code>Класс;День;Номер урока;Предмет;Учитель;Кабинет</code>", parse_mode="HTML")
            return
        klass, day, num, subj, teacher, room = parts[:6]
        try:
            num = int(num)
        except ValueError:
            await update.message.reply_text("❌ Номер урока должен быть числом.")
            return
        repl = {
            "class": klass,
            "day": day,
            "урок": num,
            "предмет": subj,
            "учитель": teacher,
            "кабинет": room
        }
        REPLACEMENTS.append(repl)
        save_data_store(USERS, NEWS, EVENTS, REPLACEMENTS)
        context.user_data.pop("admin_action", None)
        await update.message.reply_text("✅ Замена добавлена.")
        return

    if action == "edit_replacement":
        idx = context.user_data.get("edit_idx")
        if idx is not None and 0 <= idx < len(REPLACEMENTS):
            parts = [p.strip() for p in text.split(";")]
            if len(parts) < 6:
                await update.message.reply_text("❌ Неверный формат для замены.")
                return
            klass, day, num, subj, teacher, room = parts[:6]
            try:
                num = int(num)
            except ValueError:
                await update.message.reply_text("❌ Номер урока должен быть числом.")
                return
            REPLACEMENTS[idx] = {
                "class": klass, "day": day, "урок": num,
                "предмет": subj, "учитель": teacher, "кабинет": room
            }
            save_data_store(USERS, NEWS, EVENTS, REPLACEMENTS)
            context.user_data.pop("admin_action", None)
            context.user_data.pop("edit_idx", None)
            await update.message.reply_text("✅ Замена обновлена.")
        return

async def unknown_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("❓ Я не понял. Используйте меню или команды: /start, /reset_settings, /whoami")

def build_app():
    app = Application.builder().token(BOT_TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("reset_settings", reset_settings))
    app.add_handler(CommandHandler("whoami", whoami))
    app.add_handler(CallbackQueryHandler(callback_handler))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, text_handler))
    app.add_handler(MessageHandler(filters.ALL, unknown_handler))
    return app

def main():
    application = Application.builder().token(BOT_TOKEN).build()

    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("reset_settings", reset_settings))
    application.add_handler(CommandHandler("whoami", whoami))

    application.add_handler(CallbackQueryHandler(callback_handler))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, text_handler))

    application.run_webhook(
        listen="0.0.0.0",
        port=PORT,
        url_path=BOT_TOKEN,
        webhook_url=f"{WEBHOOK_URL}/{BOT_TOKEN}",
        drop_pending_updates=True
    )


if __name__ == "__main__":
    main()
